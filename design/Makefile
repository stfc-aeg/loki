SHELL := /bin/bash

.PHONY: hardware software all os mostlyclean clean export_bd_tcl

PLATFORM = 4cg_2gb
OS_PATH = ./os/petalinux-custom/
VIVADO_PROJ_PATH = vivado

all: os

HARDWARE_OUTPUT = prebuilt/hardware/${PLATFORM}/design_${PLATFORM}.xsa
SOFTWARE_OUTPUT = prebuilt/software/${PLATFORM}/fsbl.elf prebuilt/software/${PLATFORM}/pmufw.elf

${VIVADO_PROJ_PATH}:
	$(warning Vivado project does not exist, attempting to create it...)
	LOKI_AUTO_CREATE="1"; \
	source ./vivado_create_project_guimode.sh
	$(info Finished creating new project...)

# Up-to-date TCL files are exported from the existing Vivado design
export_bd_tcl: | ${VIVADO_PROJ_PATH}
	$(info Updating TCL block design from Vivado block design)
	LOKI_AUTO_BUILD="TCL"; \
	source ./vivado_open_existing_project_guimode.sh
	$(info TCL block design up to date)

# Build hardware if TCL design changes or if intermiediate block design
# has been updated. However, block design should be extracted so that
# changes can be committed with 'export_tcl'
HARDWARE_DEPS = $(shell find ./block_design/)
HARDWARE_DEPS := $(shell find ./constraints/)
${HARDWARE_OUTPUT}: ${HARDWARE_DEPS} | ${VIVADO_PROJ_PATH}
	$(info Modified hardware synth dependencies: $?)
	LOKI_AUTO_BUILD="HW"; \
	source ./vivado_open_existing_project_guimode.sh
	$(info finished building hardware)
hardware: ${HARDWARE_OUTPUT} ;

SOFTWARRE_DEPS = $(shell find ../../sw_lib/sw_apps/)
${SOFTWARE_OUTPUT}: ${HARDWARE_OUTPUT} ${SOFTWARE_DEPS}
	$(info Modified software dependencies: $?)
	LOKI_AUTO_BUILD="SW"; \
	source ./vivado_open_existing_project_guimode.sh
	$(info finished building FSBL and PMUFW)
software: ${SOFTWARE_OUTPUT} ;

os: hardware software
	$(MAKE) -C ${OS_PATH} all

mostlyclean:
	# Delete built hardware and software, and mostlyclean PetaLinux project.
	$(info cleaning prebuilt hardware and software)
	rm -rf prebuilt/hardware/*
	rm -rf prebuitt/software/*
	$(info cleaning OS image files)
	$(MAKE) -C ${OS_PATH} mostlyclean

clean: mostlyclean export_bd_tcl
	# Same as mostlyclean but make sure that current design is exported to TCL
	# for revision control, and then delete vivado project. The OS is also
	# fully cleaned.
	$(info cleaning OS image and build files)
	$(MAKE) -C ${OS_PATH} clean
	$(warning Deleting Vivado project directory, changes not exported to TCL will be lost)
	rm -rf ./vivado

clobber:
	#TODO delete the project so that it must be re-configured fresh
	#TODO make sure to warn if there are unstored changes in vivado, or force-run the TCL export
	#TODO consider distclean for removing things generated by initial config
